#!/usr/bin/env bash

# Load environment variables from .env file
if [ -f .env ]; then
  export $(grep -v '^#' .env | xargs)
fi

# Define the kubeconfig file
KUBECONFIG_FILE="kubeconfigs/$KUBECONFIG"

# Define the namespace and label selector
NAMESPACE="cliper"
LABEL_SELECTOR="app=mongo"
FORWARD_PORT=27089

# Check if the kubeconfig file exists
if [ ! -f "$KUBECONFIG_FILE" ]; then
  echo "Error: kubeconfig file not found: $KUBECONFIG_FILE"
  exit 1
fi

# Get the pod name dynamically
POD_NAME=$(kubectl --kubeconfig="$KUBECONFIG_FILE" get pods -n "$NAMESPACE" -l "$LABEL_SELECTOR" -o jsonpath='{.items[0].metadata.name}')

# Check if a pod name was found
if [ -z "$POD_NAME" ]; then
  echo "Error: No pod found with label $LABEL_SELECTOR in namespace $NAMESPACE"
  exit 1
fi

echo "Forwarding port for pod: $POD_NAME"

# Forward the port
kubectl --kubeconfig="$KUBECONFIG_FILE" port-forward "$POD_NAME" $FORWARD_PORT:27017 -n "$NAMESPACE"
